  <!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" >
<style type="text/css">
    div#rMenu {
        position: absolute;
        visibility: hidden;
        text-align: left;
        padding: 2px;
        width: auto;
        border: 1px
    }

    .ztree li {
        padding: 0;
        margin: 0;
        list-style: none;
        line-height: 20px;
        text-align: left;
        white-space: nowrap
    }

    .ztree li span {
        margin-right: 2px;
        font-weight: lighter;
        font-size: 14px;
        color: #000;
        font-family: inherit;
    }
</style>
<section class="content-header" style="">
    <h1 ><span th:text="${funName}">åŠŸèƒ½åç§°</span>
        <small th:text="${funDescript}"> åŠŸèƒ½æè¿° </small>
    </h1>
    <ol class="breadcrumb">
        <li><i class="fa fa-dashboard"></i> <span  th:text="${topModuleName}">ä¸€çº§æ¨¡å—</span></li>
        <li  th:text="${moduleName}"> äºŒçº§æ¨¡å—</li>
        <li class="active"  th:text="${funName}">åŠŸèƒ½åç§°</li>
    </ol>
</section>

<section class="content">
    <div class="row">
        <div class="col-xs-12">
            <div class="box">
                <!-- /.box-header -->
                <div class="box-body">
                    <div class="col-xs-12 col-sm-2"  style="padding-right: 0px;padding-left: 0px;line-height: 1.75;">
                        <div class="panel panel-default">
                            <div class="panel-heading">æ•°æ®è¡¨æ ‘</div>
                            <div class="panel-body" id="treeBody"  style=" border: 0px;padding-bottom: 10px;overflow:auto;">
                                <ul id="tree" class="ztree"></ul>
                            </div>
                        </div>
                        <div class="panel panel-default">
                            <div class="panel-heading"><span class="fa fa-bookmark"></span> æç¤º</div>
                            <div class="panel-body" style="padding:10px;border: 0px;">
                                <span style="font-size: 10px">ğŸŒ¹</span> é¼ æ ‡å³é”®æ ‘èŠ‚ç‚¹å¯<span style="color: orangered"><i>æ–°å¢ã€ä¿®æ”¹ã€åˆ é™¤</i></span> è¡¨
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-12 col-sm-10"  style="padding-right: 0px;">
                        <div class="panel panel-default">
                            <div class="panel-heading" style="padding: 0px 5px;">
                                <ul id="myTab" class="nav nav-tabs">
                                    <li class="active">
                                        <a href="#divMain" data-toggle="tab">
                                            è¡¨å­—æ®µç®¡ç†
                                        </a>
                                    </li>
                                </ul>
                            </div>

                            <div class="box-body"  id="divMain">
                                <div id="toolbar">
                                    <form class="form-inline" id="searchForm">
                                        <input type="text" class="form-control input-sm" name="pId" style="display: none;" placeholder="ç‚¹å‡»æ ‘idå€¼">
                                        <div class="form-group" style="padding-left: 5px;">
                                            <label for="column_name"> å­—æ®µå</label>
                                            <input type="text" class="form-control input-sm" name="column_name" id="column_name" placeholder="è¯·è¾“å…¥å­—æ®µå">
                                            <label for="column_comment"> å­—æ®µæè¿°</label>
                                            <input type="text" class="form-control input-sm" name="column_comment" id="column_comment" placeholder="è¯·è¾“å…¥å­—æ®µæè¿°">
                                            <input type="hidden" class="form-control input-sm" name="table_id" id="table_id">
                                        </div>
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-default" onclick="javascript:$('table').bootstrapTable('refresh', {silent: true});isEditing=0;">
                                                <i class="glyphicon glyphicon-search"></i>
                                                æŸ¥è¯¢
                                            </button>
                                            <button type="reset" class="btn btn-default">
                                                <i class="glyphicon glyphicon-trash"></i>
                                                æ¸…ç©º
                                            </button>
                                        </div>
                                    </form>
                                    <div class="btn-group btn-group-sm"  th:utext="${eventBar}">
                                    </div>
                                </div>
                                <!--è¡¨æ ¼è‡ªåŠ¨å‡ºç°æ°´å¹³æ»šåŠ¨æ¡-->
                                <div class="table-responsive" style="width:100%">
                                    <table id="table" class="table text-nowrap" style="table-layout:fixed;word-break:break-all;"></table>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>
            </div>
            <!-- /.box-body -->
        </div>
        <!-- /.box -->

    </div>
    <!-- /.col -->
    </div>
    <!-- /.row -->
</section>

<!-- éšè—çš„å³é”®èœå• -->
<div id="rMenu">
    <ul role="menu" class="dropdown-menu" aria-labelledby="dropdownMenu3">
        <li  data-toggle="modal" data-target="#addModal"><a href="javastript:void();"   id="rRoot">æ·»åŠ æ ¹ç›®å½•</a></li>
        <li  data-toggle="modal" data-target="#addModal"><a href="javastript:void();"   id="rAdd">æ·»åŠ è¡¨</a></li>
        <li  data-toggle="modal" data-target="#editModal"><a href="javastript:void();" id="rEdit">ä¿®æ”¹è¡¨</a></li>
        <li  data-toggle="modal" data-target="#deleteModal"><a href="javastript:void();" id="rDel">åˆ é™¤è¡¨</a></li>
    </ul>
</div>
<!--defineModalé¡µé¢-->
<div th:if="${#strings.isEmpty(defineModalUrl)} ne true ">
    <div th:replace="${defineModalUrl} :: formWindowModal"></div>
</div>


<!--è‡ªå®šä¹‰JS-->
<div th:if="${#strings.isEmpty(defineJsUrl)} ne true ">
    <script th:replace="${defineJsUrl} :: gridScript"></script>
</div>
<!--gridé¡µé¢ -->
<div th:if="${#strings.isEmpty(gridUrl)} ne true ">
    <script th:replace="${gridUrl} :: gridScript"></script>
</div>
<script  th:inline="javascript">

    //åå°Controllerä¼ å›æ¥ä¸‹åˆ—å€¼
    var topModuleId = [[${topModuleId}]];//ä¸€çº§æ¨¡å—id
    var moduleId = [[${moduleId}]];//äºŒçº§æ¨¡å—id
    funId = [[${funId}]];//åŠŸèƒ½id
    funName = [[${funName}]];//åŠŸèƒ½åç§°
    var pageType = [[${pageType}]];//é¡µé¢ç±»å‹
    keyIDColumn = "column_id";//[[${keyIDColumn}]];//ä¸»é”®idåˆ—
    var allowEidtRole = [[${allowEidtRole}]];//ç¼–è¾‘æƒé™
    var treeURL = [[${getTreeDataUrl}]];//æ ‘è·å–
    var treeTopId = [[${treeTopId}]];//æ ‘é¡¶çº§id
    var treeWhereSQL = [[${treeWhereSQL}]];//æ ‘è¿‡æ»¤sql
    var allowEidtRole = [[${allowEidtRole}]];//ç¼–è¾‘æƒé™
    defaultQueryId= [[${defaultQueryId}]];//é»˜è®¤æŸ¥è¯¢æ¡id
    var getDataUrl = [[${getDataUrl}]];//gridè·å–æ•°æ®url
    importforeignKeyId = [[${importforeignKeyId}]];//å¯¼å…¥ç›®æ ‡è¡¨çš„å¤–é”®å€¼
    targetFunID = [[${targetFunID}]];//å¯¼å…¥ç›®æ ‡åŠŸèƒ½funid
    auditColumn= [[${auditColumn}]];//å¤æ ¸å­—æ®µ

    allowEidtRole=allowEidtRole=="true";

    var $table = $('#table');
    var changeRows = new Array();


    $(function () {
        try{//åˆ·æ–°æµè§ˆå™¨æ—¶ï¼Œç‚¹å‡»é“¾æ¥è¿›å…¥æ—¶ï¼Œé»˜è®¤é€‰ä¸­å¯¹åº”æ¨¡å—èœå•

            if (urlentry) {
                var selectNav = $('#mainNav').find("li[module-id='menu-" + topModuleId + "']");
                var rgb = selectNav.css("color");
                if (rgb.indexOf("#") < 0) {//ieæ˜¯#333333æ ¼å¼
                    rgb = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
                    function hex(x) {
                        return ("0" + parseInt(x).toString(16)).slice(-2);
                    }

                    rgb = "#" + hex(rgb[1]) + hex(rgb[2]) + hex(rgb[3]);
                }
                if (rgb == "#333333" && pageType != "sub" && pageType != "select" && pageType != "import" && pageType != "") {
                    selectNav.click();
                    if (!$("#menu-" + topModuleId).find("a[module-id='" + moduleId + "']").parent().hasClass("menu-open")) {
                        $("#menu-" + topModuleId).find("a[module-id='" + moduleId + "']").click();
                    }

                }
            }
        }catch (e){}
        $("#treeBody").css("height",document.body.clientHeight-280);
        // bootstrap tableåˆå§‹åŒ–
        // http://bootstrap-table.wenzhixin.net.cn/zh-cn/documentation/
        $table.bootstrapTable({
            url: CONTEXT_PATH + getDataUrl+ (getDataUrl.indexOf("?")>0?"&":"?")+"funId="+funId,
            idField: 'column_id',
            toolbar: '#toolbar',
            classes:"table table-bordered table-condensed table-hover table-striped",
            height:document.body.clientHeight-185,
            pageSize: 50,                       //æ¯é¡µçš„è®°å½•è¡Œæ•°ï¼ˆ*ï¼‰
            pageList: [ 20, 50, 100,500, 1000],        //å¯ä¾›é€‰æ‹©çš„æ¯é¡µçš„è¡Œæ•°ï¼ˆ*ï¼‰
            showToggle: false,                    //æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†è§†å›¾å’Œåˆ—è¡¨è§†å›¾çš„åˆ‡æ¢æŒ‰é’®
            cardView: false,                    //æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†è§†å›¾
            detailView: false,                   //æ˜¯å¦æ˜¾ç¤ºçˆ¶å­è¡¨
            showFullscreen: false,         //æ˜¯å¦æ˜¾ç¤ºå…¨å±æŒ‰é’®
            clickToSelect: true,  //ç‚¹å‡»rowé€‰ä¸­radioæˆ–CheckBox
            undefinedText:"",
            editable:true,//å¼€å¯ç¼–è¾‘æ¨¡å¼
            minimumCountColumns:3,//æœ€å°‘å…è®¸çš„åˆ—æ•°
//            rowStyle: function (row, index) {
//                //è¿™é‡Œæœ‰5ä¸ªå–å€¼ä»£è¡¨5ä¸­é¢œè‰²['active', 'success', 'info', 'warning', 'danger'];
//                var strclass = "";
//                if(row.is_pk=="1") strclass='warning';
//                return { classes: strclass }
//            },
            columns: _tableColumns,
            onDblClickCell:function (field, value, row, $element) {
                if(!allowEidt){
                    allowEidt=true;//åŒå‡»æ‰“å¼€ç¼–è¾‘çŠ¶æ€
                    editTableCell(field, value, row, $element);
                }
            },
            onClickCell: editTableCell ,
            initBodySuccess:function (data) {
                isEditing=0;//å°†ç¼–è¾‘æ ‡è®°æ¸…é™¤
                allowEidt=false;
                //é¼ æ ‡æ‚¬åœæ˜¾ç¤ºå…¨éƒ¨å†…å®¹~
                $('.bootstrap-table tr td').each(function () {
                    $(this).attr("title", $(this).text());
                    // $(this).css("cursor", 'pointer')
                });
                eventFresh();//äº‹ä»¶æŒ‰é’®å¯ç”¨æ€§åˆ¤æ–­
            },
            onClickRow:function(item, $element){

            }  ,
            showFooter: false  //æ˜¾ç¤ºéšè—åº•éƒ¨
            //    footerStyle: footerStyle //åº•éƒ¨æ ·å¼å‡½æ•°
        });


    });





    $(function () {
        var rMenu = $('#rMenu'),
            setting = {
                data: {
                    simpleData: {
                        enable: true,
                        idKey: 'id',
                        pIdKey: 'pId',
                        rootPId: ''
                    }
                },
                view: {
                    expandSpeed: 300,
                    // è®¾ç½®æ ‘å±•å¼€çš„åŠ¨ç”»é€Ÿåº¦ï¼ŒIE6ä¸‹é¢æ²¡æ•ˆæœ
                },
                async: {
                    enable: true,
                    // dataFilter: filter,   //function filter(treeId, parentNode, childNodes) { return childNodes;}
                    url: getAsyncUrl

                },
                callback: {
                    asyncError: zTreeOnAsyncError, // åŠ è½½é”™è¯¯çš„fun
                    beforeClick: beforeClick, // æ•è·å•å‡»èŠ‚ç‚¹ä¹‹å‰çš„äº‹ä»¶å›è°ƒå‡½æ•°
                    onRightClick: OnRightClick,
                    onAsyncSuccess: onAsyncSuccess
                }
            }, zNodes = [];

        var treeObj = $.fn.zTree.init($("#tree"), setting, zNodes);
        //å±•å¼€ç¬¬ä¸€å±‚ begin
        var openNum=0;//é»˜è®¤æ‰“å¼€å±‚æ•°
        function expandAll(treename) {
            var zTree = $.fn.zTree.getZTreeObj(treename);
            expandNodes(treename,zTree.getNodes());
        }
        function expandNodes(treename,nodes) {
            if (!nodes) return;
            var zTree = $.fn.zTree.getZTreeObj(treename);
            for (var i=0, l=nodes.length; i<l; i++) {
                zTree.expandNode(nodes[i], true, false, false);//å±•å¼€èŠ‚ç‚¹å°±ä¼šè°ƒç”¨åå°æŸ¥è¯¢å­èŠ‚ç‚¹
                if (nodes[i].isParent && nodes[i].zAsync) {
                    expandNodes(treename,nodes[i].children);//é€’å½’
                }
            }
        }

        function onAsyncSuccess(event, treeId, treeNode, msg) {
            //  var node = treeObj.getNodeByParam("id",'1002');
            //  treeObj.selectNode(node, true);
            if(openNum>0){
                expandAll("tree");
                openNum--;
            }
        }


        //å±•å¼€ç¬¬ä¸€å±‚  end

        // è·å–å¼‚æ­¥è¿æ¥
        function getAsyncUrl(treeId, treeNode) {
            return CONTEXT_PATH + treeURL + '&funId=' + funId + '&pId=' + (treeNode == undefined ? treeTopId : treeNode.id);
        }

        // åŠ è½½é”™è¯¯çš„fun
        function zTreeOnAsyncError(event, treeId, treeNode) {
            alert('æ•°æ®åŠ è½½å¤±è´¥!');
        }

        // ç‚¹å‡»ä¹‹åçš„åŠ¨ä½œ
        function beforeClick(treeId, treeNode) {
            $("#searchForm input[name='pId']").val(treeNode.id);
            //alert(treeNode.id);
            $("#table_id").val(treeNode.id);

            $("button[name='copyimport']").attr("default-disabled","0");
            $("button[name='importBtn']").attr("default-disabled","0");
            $("button[name='gridaddBtn']").attr("default-disabled","0");
            $("button[name='gridsaveBtn']").attr("default-disabled","0");
            $("button[name='sqlBtn']").attr("default-disabled","0");
            $("button[name='entityBtn']").attr("default-disabled","0");

            $("button[name='copyimport']").prop("disabled",false);
            $("button[name='importBtn']").prop("disabled",false);
            $("button[name='gridaddBtn']").prop("disabled",false);
            $("button[name='gridsaveBtn']").prop("disabled",false);
            $("button[name='sqlBtn']").prop("disabled",false);
            $("button[name='entityBtn']").prop("disabled",false);
            $('#table').bootstrapTable('refresh', {silent: true});
            isEditing=0;
        }

        //  å³é”®è§¦å‘äº‹ä»¶
        // åœ¨ztreeä¸Šçš„å³å‡»äº‹ä»¶
        function OnRightClick(event, treeId, treeNode) {
            // æ˜¯å¦å¶å­èŠ‚ç‚¹
            try {
                // åœ¨è¿™é‡Œè¿è¡Œä»£ç 
                showRMenu(event.clientX, event.clientY, treeNode.id, treeNode.name, treeNode.pId, treeNode);
            } catch (err) {
                // åœ¨è¿™é‡Œå¤„ç†é”™è¯¯
                console.log(err);
            }
        }

        // æ˜¾ç¤ºå³é”®èœå•
        function showRMenu(x, y, id, pName, pId, treeNode) {
            $('#addForm [name="parentId"]').val(id);
            $('#addForm [name="parentName"]').val(pName);
            $('#editForm [name="table_id"]').val(id);
            $('#editForm [name="table_name"]').val(treeNode.obj["table_name"]);
            $('#editForm [name="table_comment"]').val(treeNode.obj["table_comment"]);
            $('#editForm [name="order_index"]').val(treeNode.obj["order_index"]);
            var is_tree=treeNode.obj["is_tree"]==null||treeNode.obj["is_tree"]==""?"0":treeNode.obj["is_tree"];

            $('#editForm [name="is_tree"]').val(is_tree);
            $('#deleteForm [name="ids"]').val(id);
            $('#rMenu ul').show();
            // æ˜¯å¦çˆ¶idä¸º0
            if (treeNode.isParent) {
                $('#rDel').hide();
            } else {
                $('#rDel').show();
            };
            // æ˜¯å¦ç¬¬ä¸€çº§æ ‘
            if (pId!=""&&pId!="0") {
                $('#rRoot').hide();
            } else {
                $('#rRoot').show();
            }

            rMenu.css({
                "top": y + "px",
                "left": x + "px",
                "visibility": "visible"
            }); // è®¾ç½®å³é”®èœå•çš„ä½ç½®ã€å¯è§
            $("body").bind("mousedown", onBodyMouseDown);
        }


        // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
        function onBodyMouseDown(event) {
            if (!(event.target.id == "rMenu" || $(event.target).parents("#rMenu").length > 0)) {
                rMenu.css({
                    "visibility": "hidden"
                });
            }
        }

        //  rRootèŠ‚ç‚¹
        $('#rRoot').click(function () {
            $('#addForm [name="parentId"]').val("");
            $('#addForm [name="parentName"]').val("");
        });



    });


</script>
</html>